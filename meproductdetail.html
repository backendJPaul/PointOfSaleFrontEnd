<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProductDetail</title>
</head>

<body onload="initComponents()">
    <fieldset>
        <legend id="titleLegend"></legend>

        <input type="text" id="iconField" placeholder="icono" />
        <input type="text" id="descriptionField" placeholder="DescripciÃ³n" />
        <input type="text" id="purchasePriceField" placeholder="Precio de compra"/>
        <input type="text" id="salePriceField" placeholder="Precio de venta"/>
        <input type="text" id="stockField" placeholder="Stock" value="0" disabled="disabled"/>

        <select id="colorSelect"></select>
        <select id="sizeSelect"></select>
        <select id="statusSelect"></select>

        <input type="text" id="updateField" placeholder="icono de edicion" />
        <input type="text" id="deleteField" placeholder="icono de eliminacion" />
        <input type="submit" id="submitButton" />
    </fieldset>

<script>
        const module = "mproductdetail.html"
        const urlSearchParams = new URLSearchParams(window.location.search);

        const id = urlSearchParams.get("id");
        const action = urlSearchParams.get("action");

        let iconField = null;
        let nameField = null;
        let descriptionField = null;
        let urlImgField = null;
        
        let colorSelect = null;
        let sizeSelect = null;
        let statusSelect = null;

        let updateField = null;
        let deleteField = null;

        function initComponents() {

            const colorJSON = null;
            const sizeJSON = null;
            const statusJSON = null;
            const productDetailJSON = null;

            iconField = document.getElementById("iconField");
            nameField = document.getElementById("nameField");
            descriptionField = document.getElementById("descriptionField");
            urlImgField = document.getElementById("urlImgField");

            colorSelect = document.getElementById("colorSelect");
            sizeSelect = document.getElementById("sizeSelect");
            statusSelect = document.getElementById("statusSelect");

            updateField = document.getElementById("updateField");
            deleteField = document.getElementById("deleteField");

            colorLoadJSON();
            sizeLoadJSON();
            statusLoadJSON();

            if (action == "add")  {
                titleLegend.textContent = "Agregar Detalle Producto";
                document.getElementById("submitButton").addEventListener("click", save);
            }

            else {
                titleLegend.textContent = "Actualizar Detalle Producto";
                findByProductDetailIdLoadJSON(id);
                document.getElementById("submitButton").addEventListener("click", update);

            }


        }
        async function colorLoadJSON() {
            try {
                const response = await fetch("http://localhost:8080/api/color");
                const data = await response.json();
                colorJSON = data;
                document.addEventListener("DOMContentLoaded", colorContentLoaded(data));
            }
            catch (error) {
                console.log(error);
            }
        }
        function colorContentLoaded(data) {
            let option = document.createElement("option");
            option.text = "Seleccione un color";
            colorSelect.appendChild(option);

            for (let i in colorJSON) {
                option = null;
                option = document.createElement("option");
                option.text = colorJSON[i].name;
                colorSelect.appendChild(option);
            }
        }

        async function sizeLoadJSON() {
            try {
                const response = await fetch("http://localhost:8080/api/size");
                const data = await response.json();
                sizeJSON = data;
                document.addEventListener("DOMContentLoaded", sizeContentLoaded(data));
            }
            catch (error) {
                console.log(error);
            }
        }

        function sizeContentLoaded(data) {
            let option = document.createElement("option");
            option.text = "Seleccione una talla";
            sizeSelect.appendChild(option);

            for (let i in sizeJSON) {
                option = null;
                option = document.createElement("option");
                option.text = sizeJSON[i].name;
                sizeSelect.appendChild(option);
            }
        }

        async function statusLoadJSON() {
            try {
                const response = await fetch("http://localhost:8080/api/status");
                const data = await response.json();
                statusJSON = data;
                document.addEventListener("DOMContentLoaded", statusContentLoaded(data));

                
            }
            catch (error) {
                console.log(error);
            }
        }

        function statusContentLoaded(data) {
            let option = document.createElement("option");
            option.text = "Seleccione un status";
            statusSelect.appendChild(option);
            for (let i in statusJSON) {
                option = null;
                option = document.createElement("option");
                option.text = statusJSON[i].name;
                statusSelect.appendChild(option);
            }
        }


        async function findByProductDetailIdLoadJSON(id) {
            try {
                const response = await fetch(`http://localhost:8080/api/productDetail/${id}`);
                const data = await response.json();
                productDetailJSON = data;
                document.addEventListener("DOMContentLoaded", productDetailContentLoaded(data));
                

            }
            catch (error) {
                console.log(error);
            }
        }

        function productDetailContentLoaded(data){
            setFields(data);
        }

        async function save() {
            const data = {
                "icon": `${document.getElementById("iconField").value}`,
                "description": `${document.getElementById("descriptionField").value}`,
                "purchasePrice" : `${document.getElementById("purchasePriceField").value}`,
                "salePrice": `${document.getElementById("salePriceField").value}`,
                "stock" : `${document.getElementById("stockField").value}`,
                "color": {
                    "id": `${document.getElementById("colorSelect").selectedIndex}`,
                },
                "size": {
                    "id": `${document.getElementById("sizeSelect").selectedIndex}`
                },
                "product":{
                    "id": `${id}`
                },
                "status": {
                    "id": `${document.getElementById("statusSelect").selectedIndex}`
                },
                "updateField": `${document.getElementById("updateField").value}`,
                "deleteField": `${document.getElementById("deleteField").value}`
            }
            try {
                const response = await fetch(`http://localhost:8080/api/productDetail`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                }
                );
            }
            catch (error) {
                console.log(error);
            }

            window.location.href = redirectRoot + `?id=${id}`;

        }



        function setFields(data) {
            iconField.value = data.icon;
            descriptionField.value = data.description;
            purchasePriceField.value = data.purchasePrice;
            salePriceField.value = data.salePrice;
            stockField.value = data.stock;

            colorSelect.options[data.color.id].selected = true;
            sizeSelect.options[data.size.id].selected = true;
            statusSelect.options[data.status.id].selected = true;
            updateField.value = data.updateField;
            deleteField.value = data.deleteField;
        }

        async function update() {
            const data = {
                "id" : `${id}`,
                "icon": `${document.getElementById("iconField").value}`,
                "description": `${document.getElementById("descriptionField").value}`,
                "purchasePrice" : `${document.getElementById("purchasePriceField").value}`,
                "salePrice": `${document.getElementById("salePriceField").value}`,
                "stock" : `${document.getElementById("stockField").value}`,
                "color": {
                    "id": `${document.getElementById("colorSelect").selectedIndex}`,
                },
                "size": {
                    "id": `${document.getElementById("sizeSelect").selectedIndex}`
                },
                "product":{
                    "id": `${productDetailJSON.product.id}`
                },
                "status": {
                    "id": `${document.getElementById("statusSelect").selectedIndex}`
                },
                "updateField": `${document.getElementById("updateField").value}`,
                "deleteField": `${document.getElementById("deleteField").value}`
            }


            try {
                const response = await fetch(`http://localhost:8080/api/productDetail`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                }
                );
            }
            catch (error) {
                console.log(error);
            }           
            window.location.href = module + `?id=${productDetailJSON.product.id}`;
        }

    </script>
</body>

</html>