
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body onload="initComponents()">
    <fieldset>
        <legend id="titleLegend"></legend>

        <input type="text" id="iconField" placeholder="icono" value="checkroom" disabled="disabled" />
        <input type="text" id="nameField" placeholder="nombre" />
        <input type="text" id="descriptionField" placeholder="description" />
        <input type="text" id="urlImgField" placeholder="urlImg" />

        <select id="genderSelect"></select>
        <select id="categorySelect"></select>
        <select id="materialTypeSelect"></select>
        <select id="enterpriseSelect"></select>

        <input type="text" id="iconAddProductDetailField" placeholder="icono detalle de producto" value="add_circle" disabled="disabled">
        <input type="text" id="updateField" placeholder="icono de edicion" value="update" disabled="disabled" >
        <input type="text" id="deleteField" placeholder="icono de eliminacion" value="delete" disabled="disabled" />
        <input type="submit" id="submitButton" />

    </fieldset>
    <script>
        const redirectRoot = "mproduct.html"
        const urlSearchParams = new URLSearchParams(window.location.search);
        const id = urlSearchParams.get("id");

        let iconField = null;
        let nameField = null;
        let descriptionField = null;
        let urlImgField = null;
        let genderSelect = null;
        let categorySelect = null;
        let materialType = null;
        let iconAddProductDetailField = null;
        let updateField = null;
        let deleteField = null;

        function initComponents() {
            const egenderJSON = null;
            const categoryJSON = null;
            const materialTypeJSON = null;
            const entepriseJSON = null;
            
            iconField = document.getElementById("iconField");
            nameField = document.getElementById("nameField");
            descriptionField = document.getElementById("descriptionField");
            urlImgField = document.getElementById("urlImgField");
            genderSelect = document.getElementById("genderSelect");
            categorySelect = document.getElementById("categorySelect");
            materialType = document.getElementById("materialType");
            iconAddProductDetailField = document.getElementById("iconAddProductDetailField");
            updateField = document.getElementById("updateField");
            deleteField = document.getElementById("deleteField");

            egenderLoadJSON();
            categoryLoadJSON();
            materialTypeLoadJSON();
            enterpriseLoadJSON();

            if (id == null) {
                titleLegend.textContent = "Agregar Producto";
                document.getElementById("submitButton").addEventListener("click", save);
            }

            else {
                titleLegend.textContent = "Actualizar Producto";
                productByIdLoadJSON(id);
                document.getElementById("submitButton").addEventListener("click", update);

            }

        }

        async function enterpriseLoadJSON(){
            try{
                const response = await fetch("http://localhost:8080/api/enterprise");
                const data = await response.json();
                enterpriseJSON = data;
                document.addEventListener("DOMContentLoaded",enterpriseContentLoaded(data));
            }
            catch(error){
            }
        }

        async function egenderLoadJSON() {
            try {
                const response = await fetch("http://localhost:8080/api/gender");
                const data = await response.json();
                egenderJSON = data;
                document.addEventListener("DOMContentLoaded", egenderContentLoaded(data));
            }
            catch (error) {
                console.log(error);
            }
        }

        async function categoryLoadJSON() {
            try {
                const response = await fetch("http://localhost:8080/api/category");
                const data = await response.json();
                categoryJSON = data;
                document.addEventListener("DOMContentLoaded", categoryContentLoaded(data));
            }
            catch (error) {
                console.log(error);
            }
        }

        async function materialTypeLoadJSON() {
            try {
                const response = await fetch("http://localhost:8080/api/materialType");
                const data = await response.json();
                materialTypeJSON = data;
                document.addEventListener("DOMContentLoaded", materialTypeContentLoaded(data));
            }
            catch (error) {
                console.log(error);
            }
        }

        async function productByIdLoadJSON(id) {
            try {
                const response = await fetch(`http://localhost:8080/api/product/${id}`);
                const data = await response.json();
                productJSON = data;
                setFields(data);

            }
            catch (error) {
                console.log(error);
            }
        }

        function enterpriseContentLoaded(data){
            
            let option = document.createElement("option");
            option.text = "Seleccione un Provedor";
            enterpriseSelect.appendChild(option);
            for (let i in enterpriseJSON) {
                option = null;
                option = document.createElement("option");
                option.text = enterpriseJSON[i].name;
                enterpriseSelect.appendChild(option);
            }
        }

        function egenderContentLoaded(data) {
            let option = document.createElement("option");
            option.text = "Seleccione un genero";
            genderSelect.appendChild(option);
            
            for (let i in egenderJSON) {
                option = null;
                option = document.createElement("option");
                option.text = egenderJSON[i].name;
                genderSelect.appendChild(option);
            }
        }

        function categoryContentLoaded(data) {
            let option = document.createElement("option");
            option.text = "Seleccione un categoria";
            categorySelect.appendChild(option);

            for (let i in categoryJSON) {
                option = null;
                option = document.createElement("option");
                option.text = categoryJSON[i].name;
                categorySelect.appendChild(option);
            }
        }

        function materialTypeContentLoaded(data) {
            let option = document.createElement("option");
            option.text = "Seleccione un material";
            materialTypeSelect.appendChild(option);
            for (let i in materialTypeJSON) {
                option = null;
                option = document.createElement("option");
                option.text = materialTypeJSON[i].name;
                materialTypeSelect.appendChild(option);
            }
        }
        function update() {
            console.log(id);
            productByIdLoadJSON(id);

        }


        function setFields(data) {

            console.log(data);
            iconField.value = data.icon;
            nameField.value = data.name;
            descriptionField.value = data.description;

            urlImgField.value = data.urlImg;

            genderSelect.options[data.gender.id].selected = true;
            categorySelect.options[data.category.id].selected = true;
            materialTypeSelect.options[data.materialType.id].selected = true;
      
            iconAddProductDetailField.value = data.iconAddProductDetail;
            updateField.value = data.updateField;
            deleteField.value = data.deleteField;
        }

        async function update() {

            const data = {
                "id": `${id}`,
                "icon": `${iconField.value}`,
                "name": `${nameField.value}`,
                "description": `${descriptionField.value}`,
                "urlImg": `${urlImgField.value}`,
                "gender": {
                    "id": `${genderSelect.selectedIndex}`,
                },
                "category": {
                    "id": `${categorySelect.selectedIndex}`
                },
                "materialType": {
                    "id": `${materialTypeSelect.selectedIndex}`
                },
                "enterprise":{
                    "id": `${enterpriseSelect.selectedIndex}`
                },
                "iconAddProductDetail" : `${iconAddProductDetailField.value}`,
                "updateField": `${updateField.value}`,
                "deleteField": `${deleteField.value}`
            }

            console.log(data);

            try {
                const response = await fetch(`http://localhost:8080/api/product`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                }
                );
            }
            catch (error) {
                console.log(error);
            }           
          //  window.location.href = redirectRoot;
        }
        async function save() {
            const data = {
                "icon": `${document.getElementById("iconField").value}`,
                "name": `${document.getElementById("nameField").value}`,
                "description": `${document.getElementById("descriptionField").value}`,
                "urlImg": `${document.getElementById("urlImgField").value}`,
                "gender": {
                    "id": `${document.getElementById("genderSelect").selectedIndex}`,
                },
                "category": {
                    "id": `${document.getElementById("categorySelect").selectedIndex}`
                },
                "materialType": {
                    "id": `${document.getElementById("materialTypeSelect").selectedIndex}`
                },
                "enterprise":{
                    "id": `${document.getElementById("enterpriseSelect").selectedIndex}`
                },
                "iconAddProductDetail": `${document.getElementById("iconAddProductDetailField").value}`,
                "updateField": `${document.getElementById("updateField").value}`,
                "deleteField": `${document.getElementById("deleteField").value}`
            }
            console.log(data);


            try {
                const response = await fetch(`http://localhost:8080/api/product`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                }
                );
            }
            catch (error) {
                console.log(error);
            }

           window.location.href = redirectRoot;

        }

    </script>
</body>

</html>